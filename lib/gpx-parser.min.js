var gpxParser=function(){this.xmlSource="",this.jsonSource="",this.trackpoints={},this.waypoints={},this.routepoints={},this.distance=0,this.cumulDistance=[],this.elevation={},this.deniv={}};gpxParser.prototype.parse=function(t){function e(t){var e={};if(t.querySelector("bounds")){for(var r=t.querySelector("bounds"),s=[],i=0;i<r.attributes.length;i++)s[r.attributes[i].name]=r.attributes[i].value;e.bounds=s}if(t.querySelector("time")&&(e.time=t.querySelector("time").innerHTML),t.querySelector("rte")){var o=t.querySelector("rte");e.rte={},e.rte.name=o.querySelector("name").innerHTML,e.rte.desc=o.querySelector("desc").innerHTML;for(var a=t.querySelectorAll("rtept"),n=[],i=0,l=a.length;l>i;i++){var h=[];h.lat=a[i].getAttribute("lat"),h.lon=a[i].getAttribute("lon");for(var c=0;c<a[i].childNodes.length;c++)h[a[i].childNodes[c].tagName]=a[i].childNodes[c].innerHTML;n.push(h)}e.rte.rtepts=n}if(t.querySelector("trk")){var p=t.querySelector("trk");e.trk={},p.querySelector("name")&&(e.trk.name=p.querySelector("name").innerHTML),p.querySelector("desc")&&(e.trk.desc=p.querySelector("desc").innerHTML);for(var u=t.querySelectorAll("trkpt"),y=[],i=0,l=u.length;l>i;i++){var h=[];h.lat=u[i].getAttribute("lat"),h.lon=u[i].getAttribute("lon");for(var c=0;c<u[i].childNodes.length;c++)h[u[i].childNodes[c].tagName]=u[i].childNodes[c].innerHTML;y.push(h)}e.trk.trkpts=y}if(t.querySelector("wpt")){for(var d=t.querySelectorAll("wpt"),v=[],i=0,l=d.length;l>i;i++){var h=[];h.lat=d[i].getAttribute("lat"),h.lon=d[i].getAttribute("lon");for(var c=0;c<d[i].childNodes.length;c++)h[d[i].childNodes[c].tagName]=d[i].childNodes[c].innerHTML;v.push(h)}e.wpt=v}return e}var r=(new DOMParser).parseFromString(t,"text/xml");this.xmlSource=r,this.jsonSource=e(r),void 0!=this.jsonSource.trk&&(this.trackpoints=this.jsonSource.trk.trkpts),void 0!=this.jsonSource.rte&&(this.routepoints=this.jsonSource.rte.rtepts),void 0!=this.jsonSource.wpt&&(this.waypoints=this.jsonSource.wpt),this.calcElevation(),this.calcTotalDistance()},gpxParser.prototype.calcTotalDistance=function(){function t(t,e){var r=parseFloat(t.lat),s=parseFloat(t.lon),i=parseFloat(t.ele),o=parseFloat(e.lat),a=parseFloat(e.lon),n=parseFloat(e.ele),l=6366;r*=Math.PI/180,o*=Math.PI/180,s*=Math.PI/180,a*=Math.PI/180,i/=1e3,n/=1e3;var h=2*Math.asin(Math.sqrt(Math.pow(Math.sin((r-o)/2),2)+Math.cos(r)*Math.cos(o)*Math.pow(Math.sin((s-a)/2),2))),c=h*l,p=Math.sqrt(Math.pow(c,2)+Math.pow(n-i,2));return p}var e;this.isEmpty(this.trackpoints)?this.isEmpty(this.waypoints)?this.isEmpty(this.routepoints)||(e=this.routepoints):e=this.waypoints:e=this.trackpoints;var r=0;this.cumulDistance.push(0);for(var s=0;s<e.length-1;s++)r+=t(e[s],e[s+1]),this.cumulDistance.push(r);this.distance=r},gpxParser.prototype.calcElevation=function(){var t;this.isEmpty(this.trackpoints)?this.isEmpty(this.waypoints)?this.isEmpty(this.routepoints)||(t=this.routepoints):t=this.waypoints:t=this.trackpoints;for(var e=0,r=0,s={},i=0;i<t.length-1;i++){var o=parseFloat(t[i+1].ele)-parseFloat(t[i].ele);0>o?r+=o:o>0&&(e+=o)}for(var a=[],i=0,n=t.length;n>i;i++)a.push(parseFloat(t[i].ele));this.elevation=a,s.max=Math.max.apply(null,a),s.min=Math.min.apply(null,a),s["d+"]=e,s["d-"]=r,this.deniv=s},gpxParser.prototype.isEmpty=function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0};
